<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.drift.comment.mapper.CommentMapper">
    <select id="selectParentCommentList" resultType="org.drift.common.pojo.comment.CommentDto">
        SELECT
            id AS commentId,
            user_id AS userId,
            content,
            create_time AS createTime
        FROM tbl_comment
        WHERE post_id = #{postId} AND parent_comment_id IS NULL
        ORDER BY create_time DESC
        LIMIT #{page}, 10
    </select>

    <select id="selectChildCommentList" resultType="org.drift.common.pojo.comment.CommentDto">
        SELECT
            t1.parent_comment_id AS parentCommentId,
            t1.id AS commentId,
            t1.user_id AS userId,
            t1.content,
            t1.create_time AS createTime,
            COUNT(*) OVER (PARTITION BY t1.parent_comment_id) AS childCommentCount
        FROM tbl_comment t1
        INNER JOIN (
            SELECT
                parent_comment_id,
                MAX(create_time) AS create_time
            FROM tbl_comment
            WHERE reply_to_user_id IS NULL
            AND parent_comment_id IN
            <foreach collection="parentCommentIds" item="parentCommentId" open="(" separator="," close=")">
                #{parentCommentId}
            </foreach>
            GROUP BY parent_comment_id
        ) t2
        ON t1.parent_comment_id = t2.parent_comment_id AND t1.create_time = t2.create_time
        WHERE t1.reply_to_user_id IS NULL
    </select>
</mapper>